# Мастер-класс «Создаём Telegram бота» в рамках приёмной кампании РТУ МИРЭА 2025

## Часть 1. Знакомство с ведущим

Я - Лесовой Кирилл, студент 1 курса РТУ МИРЭА по направлению [ПИ РППиПИС](https://priem.mirea.ru/guide-direction?direction_id=1207)

Зимой 2024-2025 написал [тг-бота для Дня студента](https://github.com/K1rL3s/mirea-student-day), и поэтому меня позвали провести этот мастер-класс.

Начал свой путь разработчика в 9 классе, попав в Яндекс Лицей на двухгодичный курс ([тык](https://lyceum.yandex.ru/python) и [тык](https://lyceum.yandex.ru/industrial)). \
В школьное время писал ботов, бэкенды для сайтов, участвовал и побеждал в хакатонах. В апреле устроился в [Велобайк](https://velobike.ru) разработчиком внутреннего отдела автоматизации, основные обязанности - проверка фич через тг-бота и интеграция с различными сервисами.

Мои контакты [тут](https://hello.k1rles.ru), этот репозиторий [тут](https://github.com/K1rL3s/mirea-tg-bot-workshop)


## Часть 2. Введение в чат-боты

Telegram - это мессенджер, основанный Павлом и Николаем Дуровыми в 2013 году. \
Скорее всего, вы уже им давно пользуетесь. Я скачал его во время блокировок в 2018 году, и с тех пор использую его как основное приложение для общения. \
В телеге есть боты (чат-боты) - по сути, это программы, которые взаимодействуют с пользователями через текстовые или мультимедийные сообщения, в основном для автоматизации чего-то или решения каких-то проблем/задач.

Сегодня мы с вами не будем пытаться решить какую-то существующую проблему, наша цель - понять функционал тг-ботов и научиться применять его как разработчики.

_Вопросы к аудитории:_
- _Кто знаком с программированием? (например, ОГЭ/ЕГЭ по информатике, КуМир, Pascal, Python)._
- _Писали ли что-то на Python? Участвовали ли в олимпиадах или хакатонах?_


## Часть 3. Выбор инструментов

Не долго думая, берём Python из-за его простоты и низкого порога входа, и aiogram как самую совершенную библиотеку для тг-ботов на питоне.
Ещё нам понадобится база данных (о ней дальше). Мы возьмём sqlite, чтобы не разворачивать постгрю или мускуль на университетских компах.


## Часть 4. Настройка PyCharm, нового проекта, venv

1. Открываем PyCharm
2. Выбираем **Create new project** на стартовом экране
    ![Стартовый экран](./content/start-window.png)
3. Называем как хотим (я назвал его `mirea-tg-bot-workshop`) и создаём
    ![Создание проекта](./content/create-project.png)
4. Справа снизу создаём виртуальное окружение с питоном 3.9+
    ![Создание виртуального окружения](./content/create-venv.png)

Так как нам нужен будет aiogram, установим его, введя следующую команду в терминал:
```commandline
pip install aiogram
```

## Часть 5. Эхо-бот. Первый запуск

Чтобы у нас был бот, его нужно создать. Пишем [ему](https://t.me/BotFather), пишем `/newbot`, придумываем имя и юзернейм для бота. Копируем токен, он нам пригодится совсем скоро.

В корне проекта создаём файл `main.py` (у меня это `mirea-tg-bot-workshop/main.py`) и пишем в него код: [тык](05-echo-bot/1.py)

Запускаем бота (зеленая стрелочка справа сверху) и что-то пишем ему через телеграм. В ответ должны получить такое же сообщение.

Сейчас при работе бота в терминал нам ничего не выводится. Чтобы было понятнее, работает ли бот, добавим одну волшебную строку: [тык](05-echo-bot/2.py)

И теперь сделаем всё чуть красивее: [тык](05-echo-bot/3.py)

Итоговый файл этой части: [тык](full-examples/05-echo-bot.py)


## Часть 6. Обработка команд, диплинки

Как вы уже поняли после взаимодействия с BotFather, ботом можно управлять с помощью команд. \
В аиограме есть несколько способов обработки сообщений с командами: [тык](06-commands/1.py)

Самый банальный:
```python
from aiogram import F

@dp.message(F.text == "/start")
```

Уже лучше:
```python
from aiogram.filters import Command

@dp.message(Command("start"))
```

И специально для старта:
```python
from aiogram.filters import CommandStart

@dp.message(CommandStart())
```

Кто такой `F`? Это буквально "магический фильтр", через который удобно фильтровать события в аиограме.

Как им пользоваться? Просто представьте, что вместо него стоит обрабатываемое событие (Message, CallbackQuery итп), и обращайтесь к его атрибутам. \
В первом примере я использовал `F.text == "/start`, что буквально `message.text == "/start"` (проверка, что пользователь отправил боту сообщение с текстом "/start")

Кто такие диплинки? Уверен, в хомяка играли, знаете, что в ботах есть "реферальная система". \
Рефералки работают через такие ссылки: `t.me/homyakbot?start=123123`, где `homyakbot` - имя бота, а `123123` - айди того, чья эта рефералка. \
При переходе по ссылке юзер отправляет `/start 123123` (на клиенте отображается только `/start`), бот получает айдишник и запоминает, чей вы процент >:)

Теперь, зная как обрабатывать команды, добавим хэндлеры (обработчики) для старта и помощи: [тык](06-commands/2.py)

Итоговый файл этой части: [тык](full-examples/06-commands.py)


## Часть 7. Клавиатуры: Inline и Reply

В тг-ботах в основном используют два вида событий - сообщения и callback-кнопки. \
Reply-клавиатуры работают через сообщения - жмёшь на кнопку и отправляется сообщение с текстом кнопки. Начнём с них: [тык](07-keyboards/1.py) 

Такая клавиатура "живёт" вместе с сообщением, поэтому если мы (или пользователь) удалим сообщение, вместе с которым отправлена клавиатура, то она [клавиатура] исчезнет.

Inline-клавиатуры уже работают через callback'и: по нажатию на кнопку боту отправляется специальное событие CallbackQuery: [тык](07-keyboards/2.py)

Они удобны тем, что буквально "привязаны" к сообщению и содержат две части - "внешнюю" (отображаемый пользователю текст) и "внутреннюю" (callback_data, которая при нажатии отправится боту).

Итоговый файл этой части: [тык](full-examples/07-keyboards.py)


## Часть 8. Настройка локальной базы данных

Что такое база данных? Упрощая, это таблица в Excel, где лист = таблица, строка = запись, и чётко определена схема. Схема определяет, что в таблицах записи должны содержать определённую информацию в определённом порядке.

То есть мы создаём базу `database.db`, создаём таблицу `users` с колонками `id`, `name`, и теперь у всех юзеров в базе обязаны быть айдишник и имя.

Для просмотра содержимого базы можно открыть её через `DB Browser for SQLite` или через `python -m sqlite3 ./database.db`

Кто такой SQLite? Это база данных, которая хранится одним файлом там где надо. Она удобна тем, что не требует установки каких-либо сложных программ для работы с ней.

Кто такой SQL? Structured Query Language, язык структурированных запросов - язык для общения с базой данных. Как питон для бэкендов, так и скл для базы данных. \
Пока нам надо запомнить, что с его помощью мы говорим скулайту сохранять, обновлять и доставать нам информацию из файла базы данных.

Напишем класс с двумя (тремя) методами: сохранение пользователя и получение пользователя: [тык](08-database/database.py)

Итоговые файлы этой части: [бот](full-examples/08-save-user.py), [бд](full-examples/database_08.py)


## Часть 9. Анонимные сообщения через бота

Так как мы идём по пути копии `@askifybot`, попытаемся повторить всё по красоте.

Первое - диплинк, чтобы начать разговор. \
Если мы будем держать тг-айди прямо в диплинках и кнопках, то все смогут найти аккаунты отправителя и получателя. Чтобы защитить всех, нам надо добавить в таблицу колонку `id` (integer, primary key, autoincrement), которую мы и будем использовать в диплинке и кнопках.

Обновим методы работы с бд, чтобы получать юзера либо по тг_айди, либо по нашему айди: [тык](09-anon/database.py)

Добавляем диплинк, добавляем отправку диплинка новым юзерам, добавляем обработку кнопок и сообщений, в титульное сообщение отправляем кнопку с нашим айди, и по нажатию на неё ждём сообщение как при переходе по диплинку: [тык](09-anon/1.py)

## Заключение

Чего мы добились?

Умеем включать пучарм, создавать проекты и виртуальные окружения, устанавливать зависимости из интернета. \
Знаем, как создать тг-бота и заставить его отвечать нам. \
Увидели Reply и Inline клавиатуры в работе. \
Поработали с локальной базой и состояниями пользователей. \
Сделали бота с "анонимками".

## Полезные материалы

- [Бесплатная книга по тг-ботам от Груши](https://mastergroosha.github.io/aiogram-3-guide/)
- [Aiogram GitHub](https://github.com/aiogram/aiogram)
- - [Aiogram docs](https://docs.aiogram.dev/en/v3.20.0.post0/)
- - [Aiogram FSM](https://docs.aiogram.dev/en/v3.20.0post0/dispatcher/finite_state_machine/index.html)
- - [Aiogram middlewares](https://docs.aiogram.dev/en/v3.20.0post0/dispatcher/middlewares.html)
- - [Aiogram filters](https://docs.aiogram.dev/en/v3.20.0post0/dispatcher/filters/)
- - [Aiogram magic-filter](https://docs.aiogram.dev/en/v3.20.0post0/dispatcher/filters/magic_filters.html#magic-filters)
- - [Aiogram routers](https://docs.aiogram.dev/en/v3.20.0post0/dispatcher/router.html)
- [TG Bot API](https://core.telegram.org/bots/api)
- [SQL](https://habr.com/ru/articles/564390/)
- - [Python SQLite](https://habr.com/ru/articles/754400/)
